version: 2.1
jobs:
  test:
    docker:
    - image: rust:latest
    steps:
    - checkout
    - run: cargo test
  fmt:
    docker:
    - image: rust:latest
    steps:
    - checkout
    - run: rustup component add rustfmt
    - run: cargo fmt -- --check
  rpm:
    docker:
    - image: b1zzu/sic:fedora-rpmbuild-rust
    steps:
    - checkout
    - attach_workspace:
        at: ./artifacts
    - run:
        command: |
          cargo build
          cargo rpm build
          cp target/release/rpmbuild/RPMS/x86_64/sic-*.x86_64.rpm artifacts/
  release:
    docker:
    - image: b1zzu/sic:ghr
    steps:
    - attach_workspace:
        at: ./artifacts
    - run: ls -al ./artifacts
workflows:
  main:
    jobs:
    - test
    - fmt
    - rpm:
        requires:
        - fmt
        - test
    - release:
        requires:
        - rpm
